<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Breakout</title>
            <style type="text/css">
                canvas {
                border:1px dashed #000000;
                }
            </style>
    </head>

    <body onload="init()">
        <canvas id="canvas" width="800" height="600">
            Navegador não compatível com HTML5 Canvas
        </canvas>
        <button type="button" onClick="Pausar()" id = "btstart"> Iniciar </button>
        <button type="button" onClick="Reiniciar()" id = "btstart"> Reiniciar </button>
        <p id="info"></p>
        <script>

var canvas, context, btnStart, relogio,intervalo,info_display;
var gameFieldWidth, gameFieldHeight;
var heroFieldWidth, heroFieldHeight;
var frameWidth, frameHeight;
var playerPosX, playerPosY;
var playerWidth, playerHeight;
var ballWidth, ballHeight;
var ballPosX, ballPosY, ballRaio;
var ballUp, ballAngle;
var imgBarra, imgBall;
var leftPressed, rightPressed;
var speedPlayer, speedBall;
var wallMatrix, addNumRows;
var wallNumRows, wallNumColumns, wallNumRowsDraw, wallNumColumnsDraw;
var wallWidth, wallHeight, wallMargin;
var startGame;
var score;

function init(){
    canvas = document.getElementById("canvas");
    context = canvas.getContext("2d");
    btnStart = document.getElementById("btStart");
    info_display = document.getElementById("info");

    gameFieldWidth = 600;
    gameFieldHeight = 500;
    heroFieldWidth = 120;
    heroFieldHeight = 520;
    frameWidth = 40;
    frameHeight = 40;

    startGame = false;

    playerWidth = 90;
    playerHeight = 30;
    imgBarra = new Image();
    imgBarra.src = "../assets/barra.png";

    playerPosX = (gameFieldWidth - playerWidth) / 2;
    playerPosY = gameFieldHeight - playerHeight;

    ballWidth = 20;
    ballHeight = 20;
    speedBall = 20;
    ballRaio = ballWidth / 2;
    ballPosX = gameFieldWidth / 2;
    ballPosY = gameFieldHeight - playerHeight - ballRaio;
    ballAngle = Math.floor(Math.random() * 21) - 10;
    ballUp = false;
    imgBall = new Image();
    imgBall.src = "../assets/bola.png";

    leftPressed = false;
    rightPressed = false;
    speedPlayer = 10;

    wallMatrix = new Array();
    wallWidth = 60; 
    wallHeight = 30;
    wallNumRows = 15;
    wallNumColumns = 10;
    wallNumRowsDraw = 5;
    wallNumColumnsDraw = 10;
    wallMargin = 0;
    addNumRows = false;
    createWall();

    score = 0;

    drawBackground();
    
    drawBar(imgBarra, playerPosX, playerPosY);
    drawGameField();
    drawBall(imgBall, ballPosX-ballRaio, ballPosY-ballRaio);
    drawWall();
    drawGameScore();
    
    intervalo = 20; 
    Reiniciar();
    
    document.addEventListener('keyup', keyUp, false);
    document.addEventListener('keydown', keyDown, false);
    setInterval(gameLoop, 30);
    setInterval(addWallNumRows, 10000);
}

function Reiniciar()
{
	info_display.innerHTML = "Clique em Iniciar para Jogar";

	if (startGame) 
		Pausar();
	 	gameLoop(); 

}

function Pausar()
{ 
	startGame = !startGame; 
		if (startGame) 
		{ 
			relogio = setInterval("Desenhar()" , intervalo); 
			info_display.innerHTML = "Executando..."; 
			btnStart.innerHTML = "Pausar"; 
		} 
		else 
		{ 
			clearInterval(relogio); 
			info_display.innerHTML = "Pausa"; 
			btnStart.innerHTML = "Iniciar"; 
        }
}

function drawGameField() { //change name
	context.fillStyle = "white"; 
    context.fillRect(0, 0, gameFieldWidth, gameFieldHeight);
}

function drawBackground(){
    context.fillStyle = "black"; 
    context.fillRect(0, 0, canvas.width, canvas.height);
}

function drawBar(img, posX, posY){
    context.drawImage(img, posX, posY, playerWidth, playerHeight);
}

function drawBall(img, posX, posY){
    context.drawImage(img, posX, posY, ballWidth, ballHeight);
}

function createWall() {
    for (var i = 0; i < wallNumRows; i++) { 
        wallMatrix[i] = new Array();
        for (var j = 0; j < wallNumColumns; j++) { 
            var img2 = new Image();
            img2.src = "../assets/bloco.png";
            wallMatrix[i][j] = img2;
        }
    } 
}

function drawWall(){
	var contRows = 0;
    for (var i = wallNumRowsDraw-1; i >= 0 ; i--) { 
        for (var j = wallNumColumnsDraw-1; j >= 0; j--) { 
            var img = wallMatrix[i][j];
            if (img != null) {
                context.drawImage(img, (wallWidth + wallMargin) * j , (wallHeight + wallMargin) * contRows,
                		wallWidth, wallHeight);
            }
        }
        contRows ++;
    }
    
    if(addNumRows){
    	wallNumRowsDraw++;
    	addNumRows = false;
    }
}

function drawGameScore() {
    context.font = "28pt Helvetica";
    context.fillStyle = "white";
    context.fillText("Score", canvas.width - heroFieldWidth - frameWidth + 15, 2 * frameHeight);
    if (score >= 100000) {
        context.font = "22pt Helvetica";
    }
    context.fillText(score, canvas.width - heroFieldWidth - frameWidth + 15, 3 * frameHeight + 8);
}

function keyDown(e) {
    if (e.keyCode == 37) { 
        leftPressed = true;
    } else if (e.keyCode == 39) { 
        rightPressed = true;
    }
}

function keyUp(e) {
    if (e.keyCode == 37) {
    	leftPressed = false; 
    } else if (e.keyCode == 39) {
    	rightPressed = false;
    }
}

function getBarPosition() {
    if (leftPressed != rightPressed) { 
        if (leftPressed) { 
            if (playerPosX > 0) { 
            	playerPosX -= speedPlayer;
            }
            if(playerPosX < 0){
            	playerPosX = 0;
            }
        } else { 
            if (playerPosX < (gameFieldWidth - playerWidth)) {
                playerPosX += speedPlayer;
            }
            if(playerPosX > (gameFieldWidth - playerWidth)){
                playerPosX = gameFieldWidth - playerWidth;
            }
        }
    }
}

function getBallPosition(){
    if (ballPosY + ballRaio == playerPosY){
        if ((ballPosX-ballRaio >= playerPosX-ballWidth) && (ballPosX + ballRaio <= playerPosX + playerWidth + ballWidth)) {
        	ballUp = true;
            if (leftPressed) {
            	ballAngle = Math.floor(Math.random() * 10) - 9;
            }
            else {
            	ballAngle = Math.floor((Math.random() * 10));
            }                        
        }                    
    }
    if ((ballPosX-ballRaio <= 0) || (ballPosX + ballRaio > gameFieldWidth)) {
    	ballAngle = ballAngle * -1;
    }
    ballPosX += ballAngle;
    
    if (ballUp) {
        ballPosY -= speedBall;
    } else {
        ballPosY += speedBall;
    }                    
}

function checkCollisionWall(){
	var contRows = 0;
    for (var i = wallNumRowsDraw-1; i >= 0 ; i--) { 
        for (var j = wallNumColumnsDraw-1; j >= 0; j--) { 
            if (wallMatrix[i][j]) {
            	var posXwall = (wallWidth + wallMargin) * j ;
        		var posYwall = (wallHeight + wallMargin) * contRows;
        		
            	if((ballPosX - ballRaio >= posXwall-ballWidth && ballPosX + ballRaio <= posXwall + wallWidth + ballWidth)){
                	if((ballPosY - ballRaio >= posYwall-ballHeight && ballPosY + ballRaio <= posYwall + wallHeight + ballHeight)){
                		wallMatrix[i][j] = null;
                		ballUp = false;
                        score = (score + 1) % 1000000;
                	}
            	}
            }
        }
        contRows++;
    } 
}

function gameLoop() { 
	if(startGame){
		checkCollisionWall();
	    context.clearRect(0, 0, canvas.width, canvas.height);
	    drawBackground();
	    drawGameField();
	    
	    getBarPosition();
	    drawBar(imgBarra, playerPosX, playerPosY);
	    
	    getBallPosition();
	    drawBall(imgBall, ballPosX-ballRaio, ballPosY-ballRaio);

	    drawWall();
	    drawGameScore();

	}else{
		checkStartGame();
	}
}

function checkStartGame(){
	if(leftPressed || rightPressed){
		startGame = true;
	}
}

function addWallNumRows() {
	if(startGame){
		addNumRows = true;
	}
}
        </script>
    </body>
</html>

